AWSTemplateFormatVersion: '2010-09-09'

Description: This template provisions a single IAM User and an IAM User Access Key
  
Metadata:
  Purpose:
    Description: "This template is used to create a stack that implements a single IAM User with an accompanying IAM Access Key.  
                  The user can be associated with an IAM Group and/or one of several Managed Policies offered by AWS.  Each managed 
                  policy maps to a traditional user job function/role. The stack exports both the user name and ARN, and outputs
                  the access key id and secret on successful deployment."

  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: "IAM User Account Parameters"
        Parameters:
          - Group
          - ManagedPolicy
          - Password
          - PasswordResetRequired
          - Path
          - UserName
    ParameterLabels:
      Group:
        default: IAM Group
      ManagedPolicy:
        default: Managed Policy
      Password:
        default: User Password
      PasswordResetRequired:
        default: Password Reset required
      Path:
        default: Path
      UserName: 
        default: User Name


Parameters:

  Group:
    Type: String
    Description: Would you like to add this user to an IAM Group, or list of IAM Groups?
    ConstraintDescription: Must be a comma separated list of IAM Group names (group1,group2,group3)
    Default: "None"

  ManagedPolicy:
    Type: String
    Description: Would you like to associate a predefined Managed Policy with the user?
    AllowedValues:
    - Administrator
    - Billing
    - DatabaseAdministrator
    - DataScientist
    - DeveloperPowerUser
    - NetworkAdministrator
    - SecurityAuditor
    - SupportUser
    - SystemAdministrator
    - View-Only
    - None
    Default: None

  Password:
    Type: String
    Description: Please enter a password 
    ConstraintDescription: Password must be between 8 and 32 characters, start with lowercase or uppercase letter, and can be alphanumeric with the following special characters !@#$%& 
    NoEcho: true
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9!@#$%&]{8,32}$

  PasswordResetRequired:
    Type: String
    Description: Do you want to require users to create a new password on first login?
    ConstraintDescription: Must be a boolean value of true or false
    Default: "false"
    AllowedValues: 
    - "true"
    - "false"

  Path:
    Type: String
    Description: What IAM Path would you like to associate with the User?
    AllowedPattern: (^\/$)|(^\/.*\/$)
    Default: "/"

  UserName:
    Type: String
    Description: Would you like to define a UserName for the IAM User?
    AllowedPattern: ^[\w+=,.@-]{1,64}$
    ConstraintDescription: This parameter allows a string of characters consisting of upper and lowercase alphanumeric characters with no spaces, and the following special characters [\w+=,.@-]+
    Default: "None"


Mappings:

  ManagedPolicies:
    Administrator: 
      ARN: arn:aws:iam::aws:policy/AdministratorAccess
      GroupRole: AdministratorAccess
    Billing: 
      ARN: arn:aws:iam::aws:policy/job-function/Billing
      GroupRole: Billing
    DatabaseAdministrator: 
      ARN: arn:aws:iam::aws:policy/job-function/DatabaseAdministrator
      GroupRole: DatabaseAdministrator
    DataScientist: 
      ARN: arn:aws:iam::aws:policy/job-function/DataScientist
      GroupRole: DataScientist
    DeveloperPowerUser: 
      ARN: arn:aws:iam::aws:policy/PowerUserAccess
      GroupRole: PowerUserAccess
    NetworkAdministrator: 
      ARN: arn:aws:iam::aws:policy/job-function/NetworkAdministrator
      GroupRole: NetworkAdministrator
    SecurityAuditor: 
      ARN: arn:aws:iam::aws:policy/SecurityAudit
      GroupRole: SecurityAudit
    SupportUser: 
      ARN: arn:aws:iam::aws:policy/job-function/SupportUser
      GroupRole: SupportUser
    SystemAdministrator: 
      ARN: arn:aws:iam::aws:policy/job-function/SystemAdministrator
      GroupRole: SystemAdministrator
    View-Only: 
      ARN: arn:aws:iam::aws:policy/job-function/ViewOnlyAccess
      GroupRole: ViewOnlyAccess
    None: 
      ARN: arn:aws:iam::aws:policy/NoAccess
      GroupRole: NoAccess


Conditions:

  hasManagedPolicy:
    !Not [!Equals [!Ref ManagedPolicy, "None"]]

  hasUserName: 
    !Not [!Equals [!Ref UserName, "None"]]

  hasGroup:
    !Not [!Equals [!Ref Group, "None"]]


Resources:

  User:
    Type: AWS::IAM::User
    Properties:
      Groups: 
        - !If [hasGroup, !Ref Group, !Ref "AWS::NoValue"]
      LoginProfile:
        Password: !Ref Password
        PasswordResetRequired: !Ref PasswordResetRequired
      ManagedPolicyArns:
        - !If [hasManagedPolicy, !FindInMap [ManagedPolicies, !Ref ManagedPolicy, ARN], !Ref "AWS::NoValue"]
      Path: !Ref Path
      UserName: !If [hasUserName, !Ref UserName, !Ref "AWS::NoValue"]

  AccessKey:
    Type: AWS::IAM::AccessKey
    Properties: 
      UserName: !Ref User

  SESConfigSet:
    Type: 'AWS::SES::ConfigurationSet'
    Properties:
      Name: CustomConfigSet

  LambdaFunctionUserNotification:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: caller
      Handler: index.handler
      Role: !GetAtt 'LambdaRole.Arn'
      Environment:
        Variables:
          SES_CONFIG_SET_NAME:
            Ref: SESConfigSet
          SES_User_NAME:
            Ref: User
          SES_User_Password:
            Ref: Password
          SES_User_AccessKey:
            Ref: AccessKey
          SES_User_SecretKey: !GetAtt AccessKey.SecretAccessKey
      Runtime: python3.9
      Timeout: 60
      Code:
        ZipFile: |
              import os
              import boto3
              import json
              from datetime import datetime

              from_email = "bedwinlab@gmail.com"
              config_set_name = os.environ["SES_CONFIG_SET_NAME"]
              user_name = os.environ["SES_User_NAME"]
              user_pass = os.environ["SES_User_Password"]
              user_access_key = os.environ["SES_User_AccessKey"]
              user_secret_key = os.environ["SES_User_SecretKey"]
              aws_account_id = "1231234"

              client = boto3.client('ses')

              def lambda_handler(event, context):

                  body_html = f"""<html>
                      <head></head>
                      <body>
                        <h2>CYour Datascientest AWS Sandbox is live!</h2>
                        <br/>
                        <p>You have been granted access to an aws sandbox environment.
                        You could login to AWS using the following account id: </p> 
                        <p> For console access, use the following credentials: {bedwinlab@gmail.com} </p>
                          - username: {user_name}
                          - password: {user_pass}
                        <p>For programatic access, use the following access key and secret key within your aws cli:</p>
                          - AccessKey: {user_access_key}
                          - SecretKey: {user_secret_key}
                        </body>
                      </html>
                                  """

                  email_message = {
                      'Body': {
                          'Html': {
                              'Charset': 'utf-8',
                              'Data': body_html,
                          },
                      },
                      'Subject': {
                          'Charset': 'utf-8',
                          'Data': "Your Datascientest AWS Sandbox is ready",
                      },
                  }

                  ses_response = client.send_email(
                      Destination={
                          'ToAddresses': ['bedwinlab@gmail.com'],
                      },
                      Message=email_message,
                      Source=from_email,
                      ConfigurationSetName=config_set_name,
                  )
                  # print(f"ses response id received: {response['MessageId']}.")

  Primerinvoke:
    Type: AWS::CloudFormation::CustomResource
    DependsOn: LambdaFunctionUserNotification
    Version: "1.0"
    Properties:
      ServiceToken: !GetAtt LambdaFunctionUserNotification.Arn

  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: DatascientestUSerCreationRole
      Description: An execution role for a Lambda function launched by CloudFormation
      ManagedPolicyArns:
        - !Ref LambdaPolicy
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action:
          - 'sts:AssumeRole'
        
  LambdaPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: DatascientestUSerCreationPolicy
      Description: Managed policy for a Lambda function launched by CloudFormation
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'ses:*'
            Resource: '*'
          - Effect: Allow
            Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Resource: '*'
                      

Outputs:

  UserName: 
    Description: The UserName associated with the IAM User account
    Value: !Ref User
    Export:
      Name: !Join ["-", [!Ref "AWS::StackName", "user-name"]]

  UserARN:
    Description: The ARN associated with the IAM User account
    Value: !GetAtt User.Arn
    Export:
      Name: !Join ["-", [!Ref "AWS::StackName", "user-arn"]]
    
  AccessKeyId:
    Description: the Access Key Id 
    Value: !Ref AccessKey
    
  AccessKeySecret:
    Description: the Access Key Secret
    Value: !GetAtt AccessKey.SecretAccessKey